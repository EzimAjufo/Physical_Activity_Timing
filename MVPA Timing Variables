# Depends
library(magrittr)
library('tidyverse')
library('cmprsk')
library('ggsurvfit')
library("patchwork")
library ("scales")
library("colorspace")

# Load data
dat_AT = fread('complete_time_with_hours_121224.csv', stringsAsFactors = F, data.table = F)
dat_revokedconsent = fread('w7089_20241216.csv', stringsAsFactors = F, data.table = F)
dat_CVmortality = fread('cv_death_restricted_v3_202307.tsv', stringsAsFactors = FALSE, data.table = FALSE)
dat_CADhard= fread('cad_hard_202401.csv', stringsAsFactors = F, data.table = F)
dat_CADsoft = fread('cad_202401.csv', stringsAsFactors = F, data.table = F)

dat_CAD = merge(dat_CADhard, dat_CADsoft, by = "sample_id",
                    suffix = c("_CADhard", "_CADsoft"))

dat_AT = merge(dat_AT, dat_CAD, by = "sample_id", 
              all.x = T, all.y = F)

# Exclusions - revoked consent

sum(dat_revokedconsent$V1 %in% dat_AT$sample_id)
dat_AT <- dat_AT[!dat_AT$sample_id %in% dat_revokedconsent$V1, ]

# Merging phenotype files

dat_AT = merge(dat_AT, dat_CVmortality, by = "sample_id", all.x = TRUE, all.y = FALSE) 
dim(dat_AT)

# Create CV mortality variable
dat_AT$time_to_CVdeathdays = as.numeric(difftime(dat_AT$censor_date, dat_AT$end_date, unit = "days"))
dat_AT$time_to_CVdeath = dat_AT$time_to_CVdeathdays / 365

# Create CAD-related variables 
# Seedfile
system(paste0('dx download exome-seq:ea/Projects/SedentaryTime/SedTime_Phewas/Phecode_Files/projects_skhurshid_sed_phewas_v1_cox_data_sed_110524.csv'))
phecode_seed = fread('projects_skhurshid_sed_phewas_v1_cox_data_sed_110524.csv', stringsAsFactors = FALSE, data.table = FALSE, fill = TRUE, quote = "",check.names = FALSE)

# Remove triple quotes from column names
names(phecode_seed) <- gsub("\"", "", names(phecode_seed))
names(phecode_seed)

dat_AT <- merge(
  dat_AT,
  phecode_seed[, c("sample_id", "phenotype_censor_date")],
  by = "sample_id",
  all.x = TRUE
)

dat_AT$incident_disease_CADsoft = as.numeric(dat_AT$incident_disease_CADsoft)
dat_AT$prevalent_disease_CADsoft = as.numeric(dat_AT$prevalent_disease_CADsoft)

dat_AT$prev_cadsoft_accel = ifelse(dat_AT$prevalent_disease_CADsoft ==1 | 
                                                  (dat_AT$incident_disease_CADsoft  ==1 & 
                                                   dat_AT$censor_date_CADsoft <= dat_AT$end_date),
                                                    1, 0)

dat_AT$incd_cadsoft_accel= ifelse(dat_AT$incident_disease_CADsoft ==1 &
                                                 dat_AT$censor_date_CADsoft > dat_AT$end_date, 1, 0)

dat_AT$time_accel_to_cadsoft <- ifelse(
  dat_AT$has_disease_CADsoft == 0 | is.na(dat_AT$has_disease_CADsoft),
  pmin(
    as.numeric(difftime(dat_AT$censor_date_CADsoft, dat_AT$end_date, units = "days")) / 365.25,
    as.numeric(difftime(dat_AT$phenotype_censor_date, dat_AT$end_date, units = "days")) / 365.25
  ),
  as.numeric(difftime(dat_AT$censor_date_CADsoft, dat_AT$end_date, units = "days")) / 365.25
)



# Step 1: Create time of day variables
# Calculate row-wise totals for morning MVPA
dat_AT$mvpa_daily_total_AM <- rowSums(dat_AT[, c("mvpa_hour7", "mvpa_hour8", "mvpa_hour9", "mvpa_hour10", "mvpa_hour11", "mvpa_hour12")], na.rm = TRUE)
dat_AT$mvpa_daily_total_AM = as.numeric(dat_AT$mvpa_daily_total_AM)
summary(dat_AT$mvpa_daily_total_AM)

# Calculate row-wise totals for afternoon MVPA
dat_AT$mvpa_daily_total_afternoon <- rowSums(dat_AT[, c("mvpa_hour13", "mvpa_hour14", "mvpa_hour15", "mvpa_hour16", "mvpa_hour17", "mvpa_hour18")], na.rm = TRUE)
dat_AT$mvpa_daily_total_afternoon = as.numeric(dat_AT$mvpa_daily_total_afternoon)
summary(dat_AT$mvpa_daily_total_afternoon)

# Calculate row-wise totals for evening MVPA
dat_AT$mvpa_daily_total_PM <- rowSums(dat_AT[, c("mvpa_hour19", "mvpa_hour20", "mvpa_hour21", "mvpa_hour22", "mvpa_hour23", "mvpa_hour24")], na.rm = TRUE)
dat_AT$mvpa_daily_total_PM = as.numeric(dat_AT$mvpa_daily_total_PM)
summary(dat_AT$mvpa_daily_total_PM)

# Calculate row-wise totals for evening MVPA
dat_AT$mvpa_daily_total_overnight <- rowSums(dat_AT[, c("mvpa_hour1", "mvpa_hour2", "mvpa_hour3", "mvpa_hour4", "mvpa_hour5", "mvpa_hour6")], na.rm = TRUE)
dat_AT$mvpa_daily_total_overnight = as.numeric(dat_AT$mvpa_daily_total_overnight)
summary(dat_AT$mvpa_daily_total_overnight)

# Step 2a: Create simple majority MVPA timing variable 
# Active and time and day classification
# Majority AM/Afternoon/PM

dat_AT$active_AM = ifelse(dat_AT$mvpa_daily_total_AM > dat_AT$mvpa_daily_total_afternoon &  
                         dat_AT$mvpa_daily_total_AM > dat_AT$mvpa_daily_total_PM,
                           1, 0)

table(dat_AT$active_AM)

dat_AT$active_afternoon = ifelse(dat_AT$mvpa_daily_total_afternoon > dat_AT$mvpa_daily_total_AM &  
                         dat_AT$mvpa_daily_total_afternoon > dat_AT$mvpa_daily_total_PM,
                           1, 0)

table(dat_AT$active_afternoon)

dat_AT$active_PM = ifelse(dat_AT$mvpa_daily_total_PM > dat_AT$mvpa_daily_total_AM &  
                         dat_AT$mvpa_daily_total_PM > dat_AT$mvpa_daily_total_afternoon,
                           1, 0)

table(dat_AT$active_PM)


dat_AT$active_overnight = ifelse(dat_AT$mvpa_daily_total_overnight > dat_AT$mvpa_daily_total_AM &  
                                    dat_AT$mvpa_daily_total_overnight > dat_AT$mvpa_daily_total_afternoon &
                                    dat_AT$mvpa_daily_total_overnight > dat_AT$mvpa_daily_total_PM,
                           1, 0)

table(dat_AT$active_overnight)



# Correct classification for active_mixed
dat_AT$active_Mixed <- ifelse(
    dat_AT$active_afternoon == 0 & 
    dat_AT$active_AM == 0 & 
    dat_AT$active_PM == 0 & 
    (
      dat_AT$mvpa_daily_total_AM == dat_AT$mvpa_daily_total_PM | 
      dat_AT$mvpa_daily_total_AM == dat_AT$mvpa_daily_total_afternoon | 
      dat_AT$mvpa_daily_total_PM == dat_AT$mvpa_daily_total_afternoon
    ),
  1,
  0
)


# Step 2b: Create simple majority MVPA timing variable (single variable)
# Correct classification for active_TOD
dat_AT$active_TOD <- ifelse(dat_AT$who_acc ==1 &
  dat_AT$active_AM == 1, "active_AM",
  ifelse(dat_AT$who_acc ==1 &
    dat_AT$active_afternoon == 1, "active_afternoon",
    ifelse(dat_AT$who_acc ==1 &
      dat_AT$active_PM == 1, "active_PM",
        ifelse(
          dat_AT$who_acc == 0, "Inactive",
          "Unclassified" # Default case for unclassified rows
        )
      )
    )
  )


# Convert active_TOD to a factor and set "Inactive" as the reference level
dat_AT$active_TOD <- factor(dat_AT$active_TOD, levels = c("Inactive", "active_AM", "active_afternoon", "active_PM", "active_Mixed", "Unclassified"))

# Check the frequency table of active_TOD
table(dat_AT$active_TOD)

dat_AT$active_TOD = as.factor(dat_AT$active_TOD)
dat_AT$active_TOD = relevel(dat_AT$active_TOD, ref = "Inactive")

# Visualize distribution

# Reshape the data from wide to long format and include active_TOD
dat_long <- dat_AT %>%
  select(starts_with("mvpa_hour"), active_TOD) %>% # Include active_TOD
  pivot_longer(cols = starts_with("mvpa_hour"), 
               names_to = "Hour", 
               values_to = "MVPA") %>%
  mutate(Hour = as.numeric(gsub("mvpa_hour", "", Hour))) # Extract numeric hour from variable names

# Filter out rows where active_TOD is "Inactive", "Mixed", or MVPA is 0/NA
dat_long <- dat_long %>%
  filter(active_TOD != "Inactive" & active_TOD != "Unclassified" & !is.na(MVPA) & MVPA > 0)

# Define custom labels for active_TOD (excluding Mixed)
custom_labels <- c(
  active_afternoon = "Afternoon",
  active_AM = "Morning",
  active_PM = "Evening"
)

# Adjusting the smoothing parameter (bandwidth)
MVPA_TOD_distribution <- ggplot(dat_long, aes(x = Hour, weight = MVPA, fill = active_TOD)) +
  geom_density(alpha = 0.5, bw = 1) + # Adjust the bandwidth with the `bw` parameter
  scale_fill_manual(values = c("#006837", "#f46d43", "#343d85"), # Custom colors (excluding Mixed)
                    labels = custom_labels) +
  scale_x_continuous(
    limits = c(0, 26), # Limit x-axis to 0-24 hours
    breaks = seq(0, 26, by = 6), # Set breaks at 6-hour intervals
    labels = c("0", "6", "12", "18", "24") # Custom labels for x-axis
  ) +
  scale_y_continuous(limits = c(0, 0.18),
    breaks = seq(0, 0.18, by = 0.02) # Increase the number of horizontal gridlines
  ) +
  labs(title = "",
       x = "Hour of the Day",
       y = "Density",
       color = "Active TOD Group",
       fill = "Active TOD Group") +
  theme_classic() +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(face = "bold", size = 14),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12), # Center and bold the title
    panel.grid.minor.y = element_blank(),                         # Remove minor gridlines (optional)
    panel.grid.major.x = element_blank(),                         # Ensure no vertical gridlines (optional)
    axis.line.x = element_line(),                                 # Preserve axis lines
    axis.line.y = element_line()
  )

# Display the plot
print(MVPA_TOD_distribution)

# Save the plot
pdf("MVPA_TOD_distribution.pdf", width = 18, height = 12)  # Open the PDF device with specified dimensions in cm
print(MVPA_TOD_distribution)  # Print the plot to the PDF device
dev.off()  # Close the PDF device



